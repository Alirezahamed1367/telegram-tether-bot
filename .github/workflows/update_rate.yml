name: Update Tether Rate

on:
  schedule:
    # یادآوری از ساعت 10:45 صبح (10:45 تهران = 7:15 UTC)
    - cron: '15 7 * * *'   # 10:45 تهران - یادآوری
    
    # اجرای خودکار هر ساعت از 11 صبح تا 7 شب (زمان تهران = UTC+3:30)
    # زمان UTC باید تنظیم شود: 11 صبح تهران = 7:30 صبح UTC
    - cron: '30 7 * * *'   # 11:00 تهران
    - cron: '30 8 * * *'   # 12:00 تهران
    - cron: '30 9 * * *'   # 13:00 تهران
    - cron: '30 10 * * *'  # 14:00 تهران
    - cron: '30 11 * * *'  # 15:00 تهران
    - cron: '30 12 * * *'  # 16:00 تهران
    - cron: '30 13 * * *'  # 17:00 تهران
    - cron: '30 14 * * *'  # 18:00 تهران
    - cron: '30 15 * * *'  # 19:00 تهران (7 شب)
  
  # امکان اجرای دستی
  workflow_dispatch:

jobs:
  # Job برای ارسال یادآوری (فقط ساعت 10:45 یا اجرای دستی)
  send-reminder:
    runs-on: ubuntu-latest
    if: github.event.schedule == '15 7 * * *' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install python-telegram-bot python-dotenv pytz
    
    - name: Send Reminder
      env:
        BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
        TARGET_GROUP_ID: ${{ secrets.TARGET_GROUP_ID }}
        TIMEZONE: Asia/Tehran
      run: |
        python reminder.py

  # Job برای به‌روزرسانی نرخ (همیشه اجرا می‌شود)
  update-rate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Load data from repository
      run: |
        # اگر فایل data.json در ریپازیتوری موجود باشد، استفاده می‌شود
        if [ -f data.json ]; then
          echo "Data file found"
        else
          echo "No data file found, will be created"
        fi
    
    - name: Restore Telethon session
      env:
        TELETHON_SESSION: ${{ secrets.TELETHON_SESSION }}
      run: |
        # بازگردانی session file از base64
        echo "$TELETHON_SESSION" | base64 -d > user_session.session
        echo "✅ Session file restored"
    
    - name: Run bot update
      env:
        BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
        TARGET_GROUP_ID: ${{ secrets.TARGET_GROUP_ID }}
        SOURCE_CHANNEL: tetherprice_toman
        TIMEZONE: Asia/Tehran
        TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
        TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
        TELEGRAM_PHONE: ${{ secrets.TELEGRAM_PHONE }}
      run: |
        # استفاده از اسکریپت خودکار که با Telethon کار می‌کند
        python auto_fetcher.py
    
    - name: Commit and push data file
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add data.json || true
        git diff --staged --quiet || git commit -m "Update data.json - $(date +'%Y-%m-%d %H:%M:%S')"
        git push || true
